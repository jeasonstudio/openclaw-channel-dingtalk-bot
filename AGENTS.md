# AGENTS.md

本文件提供给代码代理（AI coding agents）的仓库上下文，确保修改方向与当前实现一致。

## 项目定位

这是一个 OpenClaw DingTalk Channel 插件，采用 **Webhook + SessionWebhook** 模式：

- DingTalk 通过 HTTP POST 向 OpenClaw gateway 回调消息
- 插件在 `deliver` 阶段通过 `sessionWebhook` 回复消息
- 使用 `secretKey` 做 token 前缀校验与签名

## 当前架构

```text
src/
├── index.ts     # OpenClaw 插件入口（register(api)）
├── channel.ts   # ChannelPlugin 主逻辑（config/outbound/gateway/webhook）
├── runtime.ts   # PluginRuntime 存取
├── sign.ts      # DingTalk HMAC-SHA256 签名
└── types.ts     # 配置与入站消息类型
```

## 关键约束

1. 配置仅支持 `channels.dingtalk.secretKey`（可选 `enabled`）。
2. 入站固定路由：`/dingtalk-channel/message`。
3. 不额外启动独立服务，必须通过 OpenClaw gateway 路由注册。
4. 仅保证 `msgtype=text` 流程，其他消息类型默认忽略。
5. 群聊消息需命中 `@机器人`（`isInAtList` 或 `atUsers`）才继续分发。
6. 出站默认 `markdown` 消息结构。

## 签名与鉴权

- 入站鉴权：`secretKey.startsWith(req.headers.token)`
- 出站签名：
  - `timestamp = Date.now()`
  - `textToSign = "${timestamp}\n${secretKey}"`
  - `HMAC_SHA256(secretKey, textToSign)` -> base64 -> urlEncode

## 开发命令

```bash
npm run type-check
npm run lint
npm run lint:fix
```

## 修改建议

- 优先保持实现简单，不引入额外运行时依赖。
- 文档中如果出现 `plugin.ts`、`createPlugin()`、Stream/Card 相关内容，视为过时内容，应与当前 webhook 架构保持一致。
- 如需扩展消息类型，先保证 `DingTalkInboundMessage` 类型与真实 payload 对齐。
# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is an OpenClaw plugin that provides DingTalk channel integration. It allows OpenClaw bots to send and receive messages through DingTalk.

### Architecture

The project follows a standard OpenClaw plugin structure:

```
src/
├── index.ts          # Main entry point, exports public API
├── plugin.ts         # Plugin implementation, implements Plugin interface
├── channel.ts        # Channel adapter for DingTalk communication
└── types.ts          # TypeScript type definitions

dist/                 # Compiled output (generated by tsc)
```

**Key Components:**

- **DingTalkPlugin** (`src/plugin.ts`): Main plugin class implementing the OpenClaw `Plugin` interface. Handles initialization and lifecycle management.
- **DingTalkChannel** (`src/channel.ts`): Channel adapter that implements the `ChannelAdapter` interface. Handles actual communication with DingTalk API.
- **Type Definitions** (`src/types.ts`): Interfaces for plugin configuration, messages, and DingTalk API responses.

**Plugin Lifecycle:**

1. OpenClaw loads the plugin via `createPlugin()` factory function
2. `initialize(config)` is called with DingTalk configuration
3. `registerChannel(adapter)` receives the OpenClaw channel adapter
4. `start()` activates the channel
5. `stop()` gracefully shuts down

## Development Commands

```bash
# Install dependencies
npm install

# Build the project
npm run build

# Build in watch mode
npm run build:watch

# Run tests
npm test

# Run tests in watch mode
npm run test:watch

# Run tests with coverage
npm run test:coverage

# Lint code
npm run lint

# Format code with Prettier
npm run format
```

## Key Files

- `package.json`: Project configuration and scripts
- `tsconfig.json`: TypeScript compiler configuration
- `vitest.config.ts`: Test runner configuration
- `.eslintrc.json`: ESLint configuration
- `.prettierrc`: Prettier formatting rules

## DingTalk Integration

The plugin supports DingTalk robot webhooks for sending messages. Incoming messages are handled via webhooks that parse DingTalk's message payload and forward them to OpenClaw's message handling system.

**Supported Message Types:**
- Text messages
- Markdown
- Link messages
- Action cards

## Testing

Tests are written using Vitest. Place test files in `src/__tests__/` or alongside source files with `.test.ts` extension.

Example test command for a specific file:
```bash
npm test -- src/channel.test.ts
```
